<? extend 'layout.html' ?>
<script src="/static/js/modal.js"></script>

<div class="tab segment">
	<div class="container">
		<div class="introduction">
			<? local author, name = appname:match('([^/]-)/(.+)') ?>
			<h2 class="ui dividing header"> <?=name or 'Unkonwn' ?> </h2>
			<div class="ui breadcrumb">
				<a class="section" href="/">Home</a>
				<i class="right arrow icon divider"></i>
				<a class="section" href="/store">Store</a>
				<i class="right arrow icon divider"></i>
				<div class="active section">Details</div>
			</div>
		</div>
	</div>
</div>
<div class="ui basic small modal">
	<div class="header">
		Choose a local instance name
	</div>
	<div class="content">
		<div class="left">
			<i class="blue cloud download icon"></i>
		</div>
		<div class="right">
			<p>Pick up an unique local instance name</p>
			<div class="ui small input">
				<input id="app_lname" type="text" placeholder="Instance Name..."></input>
				<div class="ui corner label">
					<i class="asterisk icon"></i>
				</div>
			</div>
		</div>
	</div>
	<div class="actions">
		<div class="two fluid ui buttons">
			<div class="ui negative labeled icon button">
				<i class="remove icon"></i>
				Cancel
			</div>
			<div class="ui positive right labeled icon button">
				Install
				<i class="checkmark icon"></i>
			</div>
		</div>
	</div>
</div>

<div class="main container">
	<i class="ui large user icon"></i>
	<a href="/user/<?=author or 'symtech' ?>" > <?=author or 'Symtech Inc' ?> </a>
	<!--<a class="ui button blue right floated" href="/store/get/<?=appname?>" >Install</a> -->
	<div id="btn_install" class="ui disabled button blue right floated" onclick="ask_for_lname();">Install</div>
	<div>
		<input id="app_name" hidden="true" type="text" value="<?=name?>"/>
		<input id="app_path" hidden="true" type="text" value="<?=appname?>"/>
		<input id="app_type_input" hidden="true" type="text" value=""/>
		<input id="depends" hidden="true" type="text" value=""/>
		<input id="app_desc_input" hidden="true" type="text" value=""/>
		<input id="app_version_input" hidden="true" type="text" value=""/>
		<div>
			<i class="ui tag icon"></i>
			<i id="app_type">...</i>
		</div>
		<div>
			<i class="ui save icon"></i>
			<i id="app_version">...</i>
		</div>
		<div>
			<i class="ui comment icon"></i>
			<i id="app_desc">...</i>
		</div>
	</div>
<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="<?=appname?>" data-title="<?=appname?>" data-url="http://www.kooiot.com/app/detail/<?=appname?>"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
	var duoshuoQuery = {short_name:"kooiot"};
	(function() {
	 var ds = document.createElement('script');
	 ds.type = 'text/javascript';ds.async = true;
	 ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	 ds.charset = 'UTF-8';
	 (document.getElementsByTagName('head')[0] 
		  || document.getElementsByTagName('body')[0]).appendChild(ds);
	 })();
</script>
<!-- 多说公共JS代码 end -->


</div>

<script>
	$(document).ready(function() {
		query_info("<?=appname?>");
	});

	function deal_json(data, typ) {
		var version_place = $('#app_version');
		var version_input_place = $('#app_version_input');
		var desc_place = $('#app_desc');
		var desc_input_place = $('#app_desc_input');
		var type_place = $('#app_type');
		var type_input_place = $('#app_type_input');
		var depends_place = $('#depends');
		version_place.text(data.version);
		version_input_place.attr('value', data.version);
		desc_place.text(data.desc);
		desc_input_place.attr('value', data.desc)
		type_place.text(data.type);
		type_input_place.attr('value', data.type);
		depends_place.attr('value', JSON.stringify(data.depends));
		var btn_install = $('#btn_install');
		btn_install.removeClass('disabled');
	};

	function query_info(path) {
		$.ajax({
			type: "GET",
			dataType: "jsonp",
			url: "http://<?=srvurl or 'store.symid.com'?>/app/queryinfo",
			data:{ path : path },
			error: function(jqXHR, textStatus, errorThrown) {
				if (textStatus == "error") {
					alert(textStatus + " : " +errorThrown);
				} else {
					alert(textStatus);
				}
			},
			success: function(data, textStatus, jqXHR) {
				deal_json(data);
			}
		});
	};
	function isRegisterUserName(s) { 
		var patrn=/^[a-zA-Z]{1}([a-zA-Z0-9]|[._]){2,14}$/i; 
		if (!patrn.exec(s)) {
			return false; 
		}
		return true; 
	};
	function ask_for_lname() {
		$('.ui.modal')
			.modal('setting', {
					closable  : false,
					onDeny    : function(){
					//window.alert('Wait not yet!');
					//return false;
				},
				onApprove : function() {
					//window.alert('Approved!');
					var lname = $('#app_lname').val();
					lname = lname.trim();
					if (lname.length == 0) {
						window.alert('Instance Name cannot be empty');
						return false;
					};
					if (isRegisterUserName(lname)) {
						install_app(lname);
						return true
					};
					window.alert('只能输入3-15个以字母开头、可带数字、“_”、“.”的字串 ');
					return false;
				}
			})
			.modal('show')
			;
	};

	function install_app(lname) {
		var version = $('#app_version_input').attr('value');
		var type = $('#app_type_input').attr('value');
		var desc = $('#app_desc_input').attr('value');
		var depends = $('#depends').attr('value');
		$.post("/store/install", {path:'<?=appname?>', name:'<?=name?>', type:type, lname:lname, version:version, desc:desc, depends:depends}, function(data) {
				window.location.href="/store/backend";
				//status.text(data);
				})
		.done(function() {
				//alert("Application Started!!");
				})
		.fail(function() {
				alert("Failed to send start request!!");
				});

	};
</script>

