<? extend'layout.html'?>
<link rel="stylesheet" href="/static/library/ztree/css/zTreeStyle/zTreeStyle.css" type="text/css"/>
<script type="text/javascript" src="/static/library/ztree/js/jquery.ztree.all-3.5.min.js"></script>

<div class="tab segment">
	<div class="container">
		<div class="introduction">
			<h2 class="ui dividing header"> <?=_("Modbus")?> - <?=app.appname ?> </h2>
		</div>
	</div>
</div>

<div class="main container">
	<div class="ui two column middle aligned relaxed grid basic segment">
		<div class="six wide column">
			<p>
			<div class="ui dropdown selection modes" onChange="changeType(this)">
				<input id="modbus_modes" name="modbus_modes" type="hidden" value=-1 />
				<div class="text">MODBUS MODES</div>
				<i class="dropdown icon"></i>
				<div class="menu">
					<div class="item" data-value=0>MODBUS RTU</div>
					<div class="item" data-value=1>MODBUS TCP</div>
					<div class="item" data-value=2>MODBUS ASCII</div>
					<div class ="item" data-value=3>SERIAL SERVER</div>
				</div>
			</div>
			</p>
			<div class="ui clearing divider"></div>
			<div class="zTreeDemoBackground">
				<div class="ui small buttons">
					<div class="ui button" name="addLeaf" id="addLeaf">Add Device</div>
					<div class="ui button" id="edit" name="edit">Rename</div>
					<div class="ui button" id="remove" name="remove">Delete</div>
				</div>
				<div class="ui segment">
					<div id="treeDemo" class="ztree"></div>
				</div>
			</div>
			<div class="ui clearing divider"></div>
			<form  class="ui form">
				<div class="inline field">
					<label>CT:</label>
					<input placeholder="CT" id="ct" name="ct" type="text" value=1.000000 />
				</div>
				<div class="inline field">
					<label>PT:</label>
					<input placeholder="PT" id="pt" name="pt" type="text" value=1.000000 />
				</div>
			</form>
		</div>
		<div class="ten wide column">
			<div class="ui basic segment">
				<div class="ui button" id="pSave" name="pSave">Save</div>
				<div class="ui clearing divider"></div>
				<form class="ui form">
				<div id="RTU" name="RTU">
					<div class="inline field">
						端口:
						<div class="ui dropdown selection sPort">
							<div class="text">PORT</div>
							<i class="dropdown icon"></i>
							<div class="menu">
								<? for k, v in pairs(list) do ?>
								<div class="item" data-value="<?=v?>"><?=v?></div>
								<? end ?>
							</div>
						</div>
						波特率:
						<div class="ui dropdown selection baud">
							<input type="hidden" value=9600 />
							<div class="text">BAUD</div>
							<i class="dropdown icon"></i>
							<div class="menu">
								<div class="item" data-value=0>0</div>
								<div class="item" data-value=50>50</div>
								<div class="item" data-value=75>75</div>
								<div class="item" data-value=110>110</div>
								<div class="item" data-value=134>134</div>
								<div class="item" data-value=150>150</div>
								<div class="item" data-value=300>300</div>
								<div class="item" data-value=600>600</div>
								<div class="item" data-value=1200>1200</div>
								<div class="item" data-value=1800>1800</div>
								<div class="item" data-value=2400>2400</div>
								<div class="item" data-value=4800>4800</div>
								<div class="item" data-value=9600>9600</div>
								<div class="item" data-value=19200>19200</div>
								<div class="item" data-value=38400>38400</div>
								<div class="item" data-value=57600>57600</div>
								<div class="item" data-value=115200>115200</div>
								<div class="item" data-value=230400>230400</div>
								<div class="item" data-value=460800>460800</div>
								<div class="item" data-value=921600>921600</div>
							</div>
						</div>
						数据位:
						<div class="ui dropdown selection data_bits">
							<input type="hidden" value=8 />
							<div class="text">DATA BITS</div>
							<i class="dropdown icon"></i>
							<div class="menu">
								<div class="item" data-value=6>6</div>
								<div class="item" data-value=7>7</div>
								<div class="item" data-value=8>8</div>
							</div>
						</div>
					</div>
					<div class="inline field">
						校验位:
						<div class="ui dropdown selection parity">
							<input type="hidden" value=0 />
							<div class="text">PARITY</div>
							<i class="dropdown icon"></i>
							<div class="menu">
								<div class="item" data-value=0>NONE</div>
								<div class="item" data-value=1>ODD PARITY</div>
								<div class="item" data-value=2>EVEN PARITY</div>
							</div>
						</div>
						停止位:
						<div class="ui dropdown selection stop_bits">
							<input type="hidden" value=1 />
							<div class="text">STOP BITS</div>
							<i class="dropdown icon"></i>
							<div class="menu">
								<div class="item" data-value=1>1</div>
								<div class="item" data-value=1.5>1.5</div>
								<div class="item" data-value=2>2</div>
							</div>
						</div>
					</div>
				</div>

				<div id="TCP" name="TCP">
					<input placeholder="IP" id="sIp" name="sIp" type="text" />
					<input placeholder="PORT" id="port" name="port" type="text" />

				</div>
				<input placeholder="UNIT" id="unit" name="unit" type="text" />
				<div id="ECM" name="ECM">
					错误校验:
					<div class="ui dropdown selection ecm">
						<input type="hidden" value=0 />
						<div class="text">Error Checking Methods</div>
						<i class="dropdown icon"></i>
						<div class="menu">
							<div class="item" data-value=0>CRC</div>
							<div class="item" data-value=1>LRC</div>
						</div>
					</div>
				</div>
				</form>
					<div class="ui clearing divider"></div>
					<div class="ui button" id="advance" name="advance">高级</div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
var setting = {
	view: {
		selectedMulti: false
	},
	edit: {
		enable: true,
		showRemoveBtn: false,
		showRenameBtn: false
	},
	data: {
		keep: {
			parent:true,
			leaf:true
		},
		simpleData: {
			enable: true,
			idKey: "id",
			pIdKey: "pId",
			rootPId: 0
		}
	},
	callback: {
		beforeClick: beforeClick,
		onClick: onClick,
		beforeDrag: beforeDrag,
		beforeRemove: beforeRemove,
		beforeRename: beforeRename,
		onRemove: onRemove
	}
};

function changeType(obj)
{
	var val = $("#modbus_modes").attr("value");
	if (val == 0 || val == 2) {
		$("#RTU").show();
		$("#TCP").hide();
		$("#ECM").show();
	} else if (val == 1) {
		$("#RTU").hide();
		$("#TCP").show();
		$("#ECM").hide();
	} else if (val == 3) {
		$("#RTU").hide();
		$("#TCP").show();
		$("#ECM").show();
	} else {
		$("#RTU").hide();
		$("#TCP").hide();
		$("#ECM").hide();
	}
	$("#unit").hide(); 
	return val;
}

$("#unit").hide(); 
$("#RTU").hide();
$("#TCP").hide();
$("#ECM").hide();
var json_text = <?=json_text ?>;
//$(".ui.modes").dropdown("set value", json_text[0].config.mode);
$(".ui.dropdown").dropdown();
var tree_config;
//console.log(json_text)
if (json_text.length == 0) {
	tree_config = "";
} else {
	var tree = new Array();
	if (json_text.length == 1) {
		var treenode = new Object();
		treenode.id = json_text[0].tree.id;
		treenode.pId = json_text[0].tree.pId;
		treenode.name = json_text[0].tree.name;
		treenode.isParent = true;
		tree[0] = treenode;
	} else {
		for (var i = 0; i < json_text.length; i++) {
			var treenode = new Object();
			treenode.id = json_text[i].tree.id;
			treenode.pId = json_text[i].tree.pId;
			treenode.name = json_text[i].tree.name;
			tree[i] = treenode;
		}
	}
	tree_config = tree
}

var zNodes = tree_config;
var log, className = "dark";
function beforeClick(treeId, treeNode, clickFlag) {
	className = (className === "dark" ? "":"dark");
	showLog("[ "+getTime()+" beforeClick ]&nbsp;&nbsp;" + treeNode.name );
	return (treeNode.click != false);
}
function onClick(event, treeId, treeNode, clickFlag) {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo");
	nodes = zTree.getSelectedNodes();
	treeNode = nodes[0];
	if (treeNode) {
		var id = treeNode.id;
		var pId = treeNode.pId;
		var name = treeNode.name;
	} else {
		alert("Please select one node at first ...");
		return;
	}
	document.getElementById("ct").value = json_text[0].config.ct ? json_text[0].config.ct : "1.000000"
	document.getElementById("pt").value = json_text[0].config.pt ? json_text[0].config.pt : "1.000000"
	var mode = json_text[0].config.mode ? json_text[0].config.mode : $(".ui.modes").dropdown("get value");
	$(".ui.modes")
		.data()
		.moduleDropdown
		.action
		.activate(undefined, mode)
		;
	//var val = changeType();
	if (id == 1 && pId ==0) {
		if (mode == "0" || mode == "2") {
			$("#RTU").show();
			$("#TCP").hide();
			$("#ECM").show();
		} else if (mode == "1") {
			$("#RTU").hide();
			$("#TCP").show();
			$("#ECM").hide();
		} else if (mode == "3") {
			$("#RTU").hide();
			$("#TCP").show();
			$("#ECM").show();
		} else {
			$("#RTU").hide();
			$("#TCP").hide();
			$("#ECM").hide();
		}
		$("#unit").hide(); 
	} else {
		$("#ECM").hide();
		$("#RTU").hide();
		$("#TCP").hide();
		$("#unit").show(); 
	}
	if (mode == "1" || mode == "3") {
		for (var i = 0; i < json_text.length; i++) {
			if (id == json_text[i].tree.id && pId == json_text[i].tree.pId && name == json_text[i].tree.name) {
				document.getElementById("port").value = json_text[i].config.port;
				document.getElementById("sIp").value = json_text[i].config.sIp;
				document.getElementById("unit").value = json_text[i].config.unit;
				if (mode == "3") {
					$(".ui.ecm")
						.data()
						.moduleDropdown
						.action
						.activate(undefined, json_text[i].config.ecm)
						;
				}
				break;
			} else {
				document.getElementById("port").value = "";
				document.getElementById("sIp").value = "";
				document.getElementById("unit").value = "";
				if (mode == "3") {
					$(".ui.ecm")
						.data()
						.moduleDropdown
						.action
						.activate(undefined, 0)
						;
				}
			}
		}
	} else if (mode == "0" || mode == "2") {
		for (var i = 0; i < json_text.length; i++) {
			if (id == json_text[i].tree.id && pId == json_text[i].tree.pId && name == json_text[i].tree.name) {
				//$(".ui.sPort").dropdown("set value", json_text[i].config.sPort);
				$(".ui.sPort")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, json_text[i].config.sPort)
					;
				$(".ui.baud")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, json_text[i].config.baud)
					;
				$(".ui.data_bits")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, json_text[i].config.dbs)
					;
				$(".ui.parity")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, json_text[i].config.parity)
					;
				$(".ui.stop_bits")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, json_text[i].config.sbs)
					;
				$(".ui.ecm")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, json_text[i].config.ecm)
					;
				document.getElementById("unit").value = json_text[i].config.unit;
				break;
			} else {
				$(".ui.sPort")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, "0")
					;
				$(".ui.baud")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, "9600")
					;
				$(".ui.data_bits")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, "8")
					;
				$(".ui.parity")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, "0")
					;
				$(".ui.stop_bits")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, "1")
					;
				$(".ui.ecm")
					.data()
					.moduleDropdown
					.action
					.activate(undefined, "0")
					;
				document.getElementById("unit").value = "";
			}
		}
	} else {
		alert("Please select modbus transmission method");
	}
}		
function beforeDrag(treeId, treeNodes) {
	return false;
}
function beforeRemove(treeId, treeNode) {
	className = (className === "dark" ? "":"dark");
	showLog("[ "+getTime()+" beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
	return confirm("Confirm delete node '" + treeNode.name + "' it?");
}
function onRemove(e, treeId, treeNode) {
	showLog("[ "+getTime()+" onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
}
function beforeRename(treeId, treeNode, newName) {
	if (newName.length == 0) {
		alert("Node name can not be empty.");
		var zTree = $.fn.zTree.getZTreeObj("treeDemo");
		setTimeout(function(){zTree.editName(treeNode)}, 10);
		return false;
	}
	return true;
}
function showLog(str) {
	if (!log) log = $("#log");
	log.append("<li class='"+className+"'>"+str+"</li>");
	if(log.children("li").length > 8) {
		log.get(0).removeChild(log.children("li")[0]);
	}
}
function getTime() {
	var now= new Date(),
		h=now.getHours(),
		m=now.getMinutes(),
		s=now.getSeconds(),
		ms=now.getMilliseconds();
	return (h+":"+m+":"+s+ " " +ms);
}

var newCount = 1;
function add(e) {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
		isParent = e.data.isParent,
		nodes = zTree.getSelectedNodes(),
		treeNode = nodes[0];
	if (treeNode) {
		if (json_text.length > 0 && isParent) {
			alert("Parent node is locked and can not add Parent node.");
			return;
		}
		var max = 0;
		if (json_text.length > 1) {
			max = parseInt(json_text[0].tree.id);
			for (var i = 0; i < json_text.length; i++) {
				if (parseInt(json_text[i].tree.id) > max) {
					max = parseInt(json_text[i].tree.id);
				}
			}
			treeNode = zTree.addNodes(treeNode, {id:(max + newCount ), pId:treeNode.id, isParent:isParent, name:"new node" + (newCount++)});
		} else {
			treeNode = zTree.addNodes(treeNode, {id:(treeNode.id * 10 + newCount ), pId:treeNode.id, isParent:isParent, name:"new node" + (newCount++)});
		}
	} else {
		if (json_text.length > 0 && isParent) {
			alert("Parent node is locked and can not add Parent node.");
			return;
		}
		if ( !isParent ) {
			alert("Please add Parent node.");
			return;
		}
		treeNode = zTree.addNodes(null, {id:1, pId:0, isParent:isParent, name:"new node"});
	}
	if (treeNode) {
		zTree.editName(treeNode[0]);
		$("#RTU").hide();
		$("#TCP").hide(); 
		$("#ECM").hide();
		$("#unit").show(); 
	} else {
		newCount--;
		alert("Leaf node is locked and can not add child node.");
	}
};
function edit() {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
		nodes = zTree.getSelectedNodes(),
		treeNode = nodes[0];
	zTree.editName(treeNode);
};

function pSave(){
	var zTree = $.fn.zTree.getZTreeObj("treeDemo");
	nodes = zTree.getSelectedNodes();
	treeNode = nodes[0];
	if (treeNode) {
		var id = treeNode.id;
		var pId = treeNode.pId;
		var name = treeNode.name;
	} else {
		alert("Please select one node at first...");
		return;
	}
	var unit = document.getElementById("unit").value;
	var ct = document.getElementById("ct").value;
	var pt = document.getElementById("pt").value;
	var val = changeType();
	if (val == "0" || val == "2") {
		var sPort = $(".ui.sPort").dropdown("get value");
		var baud = $(".ui.baud").dropdown("get value");
		var dbs = $(".ui.data_bits").dropdown("get value");
		var parity = $(".ui.parity").dropdown("get value");
		var sbs = $(".ui.stop_bits").dropdown("get value");
		var ecm = $(".ui.ecm").dropdown("get value");
		console.log("sPort=", sPort, "baud=", baud, "dbs=", dbs, "parity=", parity, "sbs=", sbs, "ecm=", ecm);
		//alert($(".ui.parity").dropdown("get value"));
		$.post("", {id:id, pId:pId, name:name, mode:val, sPort:sPort, baud:baud, dbs:dbs, parity:parity, sbs:sbs, ecm:ecm, unit:unit, ct:ct, pt:pt}, function(data, status){
					if (status) {
					window.location.reload();
					}
					});
	} else if (val == "1") {
		var port = document.getElementById("port").value;
		var sIp = document.getElementById("sIp").value;
		$.post("", {id:id, pId:pId, name:name, mode:val, port:port, sIp:sIp, unit:unit, ct:ct, pt:pt}, function(data, status){
					if (status) {
					window.location.reload();
					}
					});
	} else if (val == "3") {
		var port = document.getElementById("port").value;
		var sIp = document.getElementById("sIp").value;
		var ecm = $(".ui.ecm").dropdown("get value");
		$.post("", {id:id, pId:pId, name:name, mode:val, port:port, sIp:sIp, unit:unit, ct:ct, pt:pt, ecm:ecm}, function(data, status){
					if (status) {
					window.location.reload();
					}
					});
	} else {
		alert("error");
		return;
	}
}
function remove(e) {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
		nodes = zTree.getSelectedNodes(),
		treeNode = nodes[0];
	if (nodes.length == 0) {
		alert("Please select one node at first...");
		return;
	} else {
		var id = treeNode.id;
		var pId = treeNode.pId;
		var name = treeNode.name;
	}
	for (var i = 0; i < json_text.length; i++) {
		if (id == json_text[i].tree.id && pId == json_text[i].tree.pId && name == json_text[i].tree.name) {
			//console.log(JSON.stringify(json_text));
			$.post("/apps/<?=app.appname?>/remove", {id:id, pId:pId, name:name, json_text:(JSON.stringify(json_text)), filename:"<?=app.appname?>"}, function(data){
			});
		}
	}
	var callbackFlag = $("#callbackTrigger").attr("checked");
	zTree.removeNode(treeNode, callbackFlag);
	location.reload();
};


function fontCss(treeNode) {
	var aObj = $("#" + treeNode.tId + "_a");
	aObj.removeClass("copy").removeClass("cut");
	if (treeNode === curSrcNode) {
		if (curType == "copy") {
			aObj.addClass(curType);
		} else {
			aObj.addClass(curType);
		}			
	}
};
var curSrcNode, curType;
function setCurSrcNode(treeNode) {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo");
	if (curSrcNode) {
		delete curSrcNode.isCur;
		var tmpNode = curSrcNode;
		curSrcNode = null;
		fontCss(tmpNode);
	}
	curSrcNode = treeNode;
	if (!treeNode) return;

	curSrcNode.isCur = true;			
	zTree.cancelSelectedNode();
	fontCss(curSrcNode);
};
function copy(e) {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
		nodes = zTree.getSelectedNodes();
	if (nodes.length == 0) {
		alert("Please select one node at first...");
		return;
	}
	curType = "copy";
	setCurSrcNode(nodes[0]);
};
function cut(e) {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
		nodes = zTree.getSelectedNodes();
	if (nodes.length == 0) {
		alert("Please select one node at first...");
		return;
	}
	curType = "cut";
	setCurSrcNode(nodes[0]);
};
function paste(e) {
	if (!curSrcNode) {
		alert("Please select one node to copy or cut at first...");
		return;
	}
	var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
		nodes = zTree.getSelectedNodes(),
		targetNode = nodes.length>0? nodes[0]:null;
	if (curSrcNode === targetNode) {
		alert("Can't move, the same source node and destination node.");
		return;
	} else if (curType === "cut" && ((!!targetNode && curSrcNode.parentTId === targetNode.tId) || (!targetNode && !curSrcNode.parentTId))) {
		alert("Can't move, source node is the target node's child.");
		return;
	} else if (curType === "copy") {
		targetNode = zTree.copyNode(targetNode, curSrcNode, "inner");
	} else if (curType === "cut") {
		targetNode = zTree.moveNode(targetNode, curSrcNode, "inner");
		if (!targetNode) {
			alert("Cutting failure, source node is the target node's parent.");
		}
		targetNode = curSrcNode;
	}
	setCurSrcNode();
	delete targetNode.isCur;
	zTree.selectNode(targetNode);
};

function advance() {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo");
	nodes = zTree.getSelectedNodes();
	treeNode = nodes[0];
	if (treeNode && parseInt(treeNode.id) != 1 && parseInt(treeNode.pId) != 0) {
		var id = treeNode.id;
		var pId = treeNode.pId;
		var name = treeNode.name;
	} else {
		alert("Please select one child node at first...");
		return;
	}
	window.location.href="/apps/<?=app.appname?>/" + "tree?name=" + treeNode.name;
}

$(document).ready(function(){
	$.fn.zTree.init($("#treeDemo"), setting, zNodes);
	$("#addParent").bind("click", {isParent:true}, add);
	$("#addLeaf").bind("click", {isParent:false}, add);
	$("#remove").bind("click", remove);
	//	$("#clearChildren").bind("click", clearChildren);
	$("#edit").bind("click", edit);
	$("#copy").bind("click", copy);
	$("#cut").bind("click", cut);
	$("#paste").bind("click", paste);
	//	$("#save").bind("click", save);
	$("#pSave").bind("click", pSave);
	$("#advance").bind("click", advance);
	var treeObj = $.fn.zTree.getZTreeObj("treeDemo"); 
	treeObj.expandAll(true); 
});

</script>
