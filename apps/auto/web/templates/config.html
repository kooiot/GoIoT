<? extend'layout.html'?>
<link rel="stylesheet" href="/static/library/ztree/css/zTreeStyle/zTreeStyle.css" type="text/css"/>
<script type="text/javascript" src="/static/library/ztree/js/jquery.ztree.all-3.5.min.js"></script>

<style type="text/css">
	.ztree li span.button.add {margin-left:2px; margin-right: -1px; background-position:-144px 0; vertical-align:top; *vertical-align:middle}
</style>

<div class="tab segment">
	<div class="container">
		<div class="introduction">
			<h2 class="ui dividing header"> <?=_("Config")?> - <?=app.appname ?> </h2>
			<div class="ui breadcrumb">
				<a class="section" href="/app/view/<?=app.appname?>"><?=_("App Control")?></a>
				<i class="right arrow icon divider"></i>
				<a class="section" href="/apps/<?=app.appname?>"><?=_("App Home")?></a>
			</div>
		</div>
	</div>
</div>

<div class="main container">
	<div class="ui two column relaxed grid basic segment">
		<div class="six wide column">
			<div class="ui clearing divider"></div>
			<div class="ui segment">
				<div id="treeDemo" class="ztree"></div>
			</div>
			<div class="ui clearing divider"></div>
		</div>
		<div class="ten wide column">
			<div class="ui basic segment">
				<div class="ui button" id="pSave" name="pSave">Save</div>
				<div class="ui clearing divider"></div>
				<div id="SCRIPT" name="SCRIPT">
					<div class="ui form">
						<label>UNIT:</label>
						<input placeholder="UNIT" id="unit" name="unit" type="text" />
						<div class="field">
							<label>Script:</label>
							<textarea id="textarea" name="textarea"></textarea>
						</div>
					</div>
				</div>

				<div id="INPUTS", name="INPUTS">
					<label>INPUT:</label>
					<!--
					<div class="ui selection labeled dropdown">
						<? local def = (#inputs ~= 0 and inputs[1].path or '') ?>
						<input id="input" name="input" type="hidden" value="<?=def?>"/>
						<div class="default text"><? = def ?> </div>
						<i class="dropdown icon"></i>
						<div class="menu">
							<? for _, v in pairs(inputs) do ?>
							<div class="item" data-value="<?=v.path?>"><?=v.path?></div>
							<? end ?>
						</div>
					</div>
					-->
					<div class="ui dropdown selection input">
						<? local def = (#inputs ~= 0 and inputs[1].path or '') ?>
						<div class="text">INPUTS</div>
						<i class="dropdown icon"></i>
						<div class="menu">
							<? for _, v in pairs(inputs) do ?>
							<div class="item" data-value="<?=v.path?>"><?=v.path?></div>
							<? end ?>
						</div>
					</div>

				</div>

				<div class="ui clearing divider"></div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
var setting = {
	/*
	check: {
		enable: true,
		nocheckInherit: false,
	},
	*/
	view: {
		addHoverDom: addHoverDom,
		removeHoverDom: removeHoverDom,
		selectedMulti: false
	},
	edit: {
		enable: true,
		editNameSelectAll: true,
		showRemoveBtn: showRemoveBtn,
		showRenameBtn: showRenameBtn,
		/*
		showRemoveBtn: false,
		showRenameBtn: false
		*/
	},
	data: {
		keep: {
			parent:true,
			//leaf:true
		},
		simpleData: {
			enable: true,
			idKey: "id",
			pIdKey: "pId",
			rootPId: 0
		}
	},
	callback: {
		beforeClick: beforeClick,
		onClick: onClick,
		beforeDrag: beforeDrag,
		beforeRemove: beforeRemove,
		beforeRename: beforeRename,
		onRemove: onRemove
	}
};

var json_text = <?=json_text ?>;
//$(".ui.modes").dropdown("set value", json_text[0].config.mode);
$(".ui.dropdown").dropdown();
$("#SCRIPT").hide();
$("#INPUTS").hide();
var tree_config;
//console.log(json_text)
if (json_text.length == 0) {
	tree_config = "";
} else {
	var tree = new Array();
	if (json_text.length == 1) {
		var treenode = new Object();
		treenode.id = json_text[0].tree.id;
		treenode.pId = json_text[0].tree.pId;
		treenode.name = json_text[0].tree.name;
		treenode.isParent = true;
		tree[0] = treenode;
	} else {
		for (var i = 0; i < json_text.length; i++) {
			var treenode = new Object();
			treenode.id = json_text[i].tree.id;
			treenode.pId = json_text[i].tree.pId;
			treenode.name = json_text[i].tree.name;
			tree[i] = treenode;
		}
	}
	tree_config = tree
}

var zNodes = tree_config;
var log, className = "dark";
function beforeClick(treeId, treeNode, clickFlag) {
	className = (className === "dark" ? "":"dark");
	showLog("[ "+getTime()+" beforeClick ]&nbsp;&nbsp;" + treeNode.name );
	return (treeNode.click != false);
}
function onClick(event, treeId, treeNode, clickFlag) {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo");
	nodes = zTree.getSelectedNodes();
	treeNode = nodes[0];
	if (treeNode) {
		var id = treeNode.id;
		var pId = treeNode.pId;
		var name = treeNode.name;
	} else {
		alert("Please select one node at first ...");
		return;
	}
	/*
	var unit = document.getElementById("unit").value;
	var str = document.getElementById("textarea").value;
	var input = document.getElementById("input").value;
	*/
	if (treeNode.level == 1) {
		$("#SCRIPT").show();
		$("#INPUTS").hide();
	} else if (treeNode.level == 2) {
		$("#INPUTS").show();
		$("#SCRIPT").hide();
	} else {
		$("#SCRIPT").hide();
		$("#INPUTS").hide();
	}
	for (var i = 0; i < json_text.length; i++) {
		if (id == json_text[i].tree.id && pId == json_text[i].tree.pId && name == json_text[i].tree.name) {
			document.getElementById("unit").value = json_text[i].config.unit;
			document.getElementById("textarea").value = json_text[i].config.str;
			//document.getElementById("input").value = json_text[i].config.input;
			$(".ui.input")
				.data()
				.moduleDropdown
				.action
				.activate(undefined, json_text[i].config.input)
				;
		}
	}

}		
function beforeDrag(treeId, treeNodes) {
	return false;
}
function beforeRemove(treeId, treeNode) {
	className = (className === "dark" ? "":"dark");
	showLog("[ "+getTime()+" beforeRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
	var isTrue = confirm("Confirm delete node '" + treeNode.name + "' it?");
	if (isTrue) {
		var zTree = $.fn.zTree.getZTreeObj("treeDemo");
		nodes = zTree.getSelectedNodes();
		treeNode = nodes[0];
		var id = treeNode.id;
		var pId = treeNode.pId;
		var name = treeNode.name;
		for (var i = 0; i < json_text.length; i++) {
			if (id == json_text[i].tree.id && pId == json_text[i].tree.pId && name == json_text[i].tree.name) {
				//console.log(JSON.stringify(json_text));
				$.post("/apps/<?=app.appname?>/remove", {id:id, pId:pId, name:name, json_text:(JSON.stringify(json_text)), filename:"<?=app.appname?>"}, function(data){
							});
			}
		}
		var callbackFlag = $("#callbackTrigger").attr("checked");
		zTree.removeNode(treeNode, callbackFlag);
		location.reload();
	}

	return isTrue;
}
function onRemove(e, treeId, treeNode) {
	showLog("[ "+getTime()+" onRemove ]&nbsp;&nbsp;&nbsp;&nbsp; " + treeNode.name);
}
function beforeRename(treeId, treeNode, newName) {
	if (newName.length == 0) {
		alert("Node name can not be empty.");
		var zTree = $.fn.zTree.getZTreeObj("treeDemo");
		setTimeout(function(){zTree.editName(treeNode)}, 10);
		return false;
	}
	return true;
}
function showLog(str) {
	if (!log) log = $("#log");
	log.append("<li class='"+className+"'>"+str+"</li>");
	if(log.children("li").length > 8) {
		log.get(0).removeChild(log.children("li")[0]);
	}
}
function getTime() {
	var now= new Date(),
		h=now.getHours(),
		m=now.getMinutes(),
		s=now.getSeconds(),
		ms=now.getMilliseconds();
	return (h+":"+m+":"+s+ " " +ms);
}

var newCount = 1;
function addHoverDom(treeId, treeNode) {
	var sObj = $("#" + treeNode.tId + "_span");
	if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
	var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
		+ "' title='add node' onfocus='this.blur();'></span>";
	sObj.after(addStr);
	var btn = $("#addBtn_"+treeNode.tId);
	if (btn) btn.bind("click", function(){
		//var zTree = $.fn.zTree.getZTreeObj("treeDemo");
		//zTree.addNodes(treeNode, {id:(100 + newCount), pId:treeNode.id, name:"new node" + (newCount++)});
		var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
		nodes = zTree.getSelectedNodes();
		treeNode = nodes[0];
		isParent = treeNode.isParent;
		var max = 0;
		if (json_text.length > 1) {
			max = parseInt(json_text[0].tree.id);
			for (var i = 0; i < json_text.length; i++) {
				if (parseInt(json_text[i].tree.id) > max) {
					max = parseInt(json_text[i].tree.id);
				}
			}
			treeNode = zTree.addNodes(treeNode, {id:(max + newCount ), pId:treeNode.id, name:"new node" + (newCount++)});
		} else {
			if (treeNode.level <= 1) {
				treeNode = zTree.addNodes(treeNode, {id:(treeNode.id * 10 + newCount ), pId:treeNode.id, name:"new node" + (newCount++)});
			}
		}
		return false;
	});
};
function showRemoveBtn(treeId, treeNode) {
	return treeNode.level != 0;
	//return !treeNode.isParent;
}
function showRenameBtn(treeId, treeNode) {
	return treeNode.level != 0;
	//return !treeNode.isParent;
}
function removeHoverDom(treeId, treeNode) {
	$("#addBtn_"+treeNode.tId).unbind().remove();
};

function pSave(){
	var zTree = $.fn.zTree.getZTreeObj("treeDemo");
	nodes = zTree.getSelectedNodes();
	treeNode = nodes[0];
	if (treeNode) {
		var id = treeNode.id;
		var pId = treeNode.pId;
		var name = treeNode.name;
		var level = treeNode.level;
	} else {
		alert("Please select one node at first...");
		return;
	}
	var unit = document.getElementById("unit").value;
	var str = document.getElementById("textarea").value;
	//var input = document.getElementById("input").value;
	var input = 0
	if (level == 2)
		input = $(".ui.input").dropdown("get value") ? $(".ui.input").dropdown("get value") : 0;
	//console.log(id, pId, name, level, str, unit, input);
	$.post("", {id:id, pId:pId, name:name, level:level, unit:unit, str:str, input:input}, function(data, status){
				if (status) {
				window.location.reload();
				}
				});
}

function advance() {
	var zTree = $.fn.zTree.getZTreeObj("treeDemo");
	nodes = zTree.getSelectedNodes();
	treeNode = nodes[0];
	if (treeNode && parseInt(treeNode.id) != 1 && parseInt(treeNode.pId) != 0) {
		var id = treeNode.id;
		var pId = treeNode.pId;
		var name = treeNode.name;
	} else {
		alert("Please select one child node at first...");
		return;
	}
	window.location.href="/apps/<?=app.appname?>/" + "tree?name=" + treeNode.name;
}

$(document).ready(function(){
	$.fn.zTree.init($("#treeDemo"), setting, zNodes);
	$("#pSave").bind("click", pSave);
	$("#advance").bind("click", advance);
	var treeObj = $.fn.zTree.getZTreeObj("treeDemo"); 
	treeObj.expandAll(true); 
	var nodes=treeObj.getNodes();
	nodes[0].nocheck = true;
	treeObj.updateNode(nodes[0]);
});

</script>
